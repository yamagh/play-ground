# 1-5. コラム: ビルドの仕組み

開発環境をセットアップする際に `sbt run` と `npm run hmr` という2つのコマンドを実行しました。この章では、これら2つのプロセスがどのように連携し、最終的にブラウザで表示されるアプリケーションを構築しているのか、その「ビルドの仕組み」を解説します。

## 役割分担: sbt と webpack

このプロジェクトのビルドシステムは、バックエンドとフロントエンドで明確に役割が分かれています。

- **sbt (The Scala Build Tool)**:
  - **担当**: バックエンド
  - **処理対象**: `app` ディレクトリ内のJava/Scalaソースコード、`conf` ディレクトリの設定ファイルなど。
  - **役割**: Java/Scalaコードをコンパイルして実行可能な状態にし、Play Frameworkサーバーを起動します。

- **webpack**:
  - **担当**: フロントエンド
  - **処理対象**: `app/assets/svelte` ディレクトリ内のSvelteコンポーネント（`.svelte`）とTypeScriptファイル（`.ts`）。
  - **役割**: これらのファイルをブラウザが解釈できる単一または複数のJavaScriptファイル（バンドル）に変換します。また、開発中はHMRサーバーとして機能し、コードの変更を即座にブラウザに反映させます。

## ビルド成果物の流れ

では、フロントエンドのビルド成果物（JavaScriptファイル）は、どのようにしてバックエンドサーバーからブラウザに配信されるのでしょうか。そこには、`target` ディレクトリを介した連携があります。

1.  **webpackによるビルド**:
    `npm run hmr` (または本番ビルド用の `npm run build`) を実行すると、webpackは `app/assets/svelte` 内のソースコードを処理します。
    - SvelteコンポーネントはJavaScriptにコンパイルされます。
    - TypeScriptはJavaScriptにトランスパイルされます。
    - 複数のファイルが1つ（または複数）のJavaScriptファイルにまとめられます。
    - この最終的な成果物が、プロジェクトルートにある **`target/web/public/main/javascripts/bundle`** ディレクトリ内に出力されます。

2.  **Play Frameworkによる配信**:
    Play Frameworkは、`target/web/public/main` ディレクトリを、アプリケーションの静的アセット（画像、CSS、JavaScriptなど）を配置する場所として認識するように設定されています。（これは `build.sbt` の設定によるものです）
    
    `sbt run` で起動したPlayサーバーは、ブラウザから `/assets/javascripts/bundle/...` のようなURLでリクエストが来ると、`target/web/public/main/javascripts/bundle/...` にあるファイルを静的ファイルとしてブラウザに配信します。

    `app/views/screen.scala.html` の中で、`@loadSvelteAssets("...")` というヘルパー関数がこのJavaScriptファイルを読み込むための `<script>` タグを生成しています。

このように、**webpackがフロントエンドのソースコードをビルドして`target`ディレクトリに出力し、Play Frameworkがその成果物を静的アセットとして配信する**、という連携によって、バックエンドとフロントエンドが統合されたアプリケーションが実現されています。

この仕組みを理解することで、開発中に問題が発生した際に、原因がバックエンド側にあるのか、フロントエンドのビルドプロセスにあるのかを切り分けやすくなります。
