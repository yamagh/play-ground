# 5-4. フィードバックメッセージの表示

フォームを保存した後に一覧画面に戻るだけでは、ユーザーは自分の操作が本当に成功したのか少し不安に思うかもしれません。「タスクを登録しました」「更新が完了しました」といったフィードバックメッセージを表示することで、アプリケーションは格段に使いやすくなります。

このような、コンポーネントをまたいで状態（この場合は表示すべきメッセージ）を共有したい場合に非常に便利なのが、Svelteの「**ストア（Stores）**」です。

## Svelteストアの活用

Svelteストアは、コンポーネントツリーの外で値を管理するためのシンプルな仕組みです。どのコンポーネントからでもストアの値を購読（subscribe）したり、値を更新したりできます。

このプロジェクトには、アプリケーション全体でフィードバックメッセージを管理するためのストアが `app/assets/svelte/stores/message.ts` にあらかじめ用意されています。

**`app/assets/svelte/stores/message.ts` (抜粋)**
```typescript
import { writable } from 'svelte/store';

// メッセージの型定義
export type Message = {
  color: 'success' | 'danger' | 'warning' | 'info';
  text: string;
};

// ストア本体。writableストアを作成。
export const message = writable<Message | null>(null);

// メッセージを表示するためのヘルパー関数
export function showSuccess(text: string) {
  message.set({ color: 'success', text });
  // 5秒後に自動的にメッセージを消す
  setTimeout(() => message.set(null), 5000);
}

// (showErrorなどの他のヘルパー関数も同様)
```
- **`writable`**: Svelteに組み込まれているストアの一種で、`.set()` メソッドや `.update()` メソッドを使って外部から値を書き換えることができます。
- **`showSuccess(text)`**: この関数を呼び出すだけで、メッセージの種類（色）と内容をストアにセットし、さらに5秒後に自動的に消す（ストアの値を `null` に戻す）タイマーまで設定してくれます。

## メッセージの表示とクリア

このストアの仕組みを利用して、フィードバックメッセージ機能を追加します。

### 1. メッセージのセット (フォーム側)

まず、`task-edit/Page.svelte` の `handleSubmit` 関数を修正し、API呼び出しが成功したときにメッセージストアを更新するようにします。

**`app/assets/svelte/screens/task-edit/Page.svelte`**
```svelte
<script lang="ts">
  // ... (importを追加)
  import { showSuccess } from '~/stores/message';

  // ...

  async function handleSubmit() {
    try {
      if (isEditing) {
        await api.put(`tasks/${id}`, task);
        showSuccess('タスクを更新しました。'); // 更新メッセージをセット
      } else {
        await api.post('tasks', task);
        showSuccess('タスクを登録しました。'); // 登録メッセージをセット
      }
      location.href = '/tasks';
    } catch (e) {
      console.error(e);
      // ここでエラーメッセージを表示することも可能
    }
  }
</script>
```
`showSuccess` 関数を呼び出すだけで、メッセージがストアにセットされます。ページ遷移後もストアの状態は維持されるため、次のページでこのメッセージを受け取ることができます。

### 2. メッセージの表示 (レイアウト側)

次に、セットされたメッセージを画面に表示する処理を追加します。このメッセージはどの画面でも表示されるべきなので、共通レイアウトコンポーネントである `LayoutSideMenu.svelte` に実装するのが適切です。

`app/assets/svelte/layouts/LayoutSideMenu.svelte` を開くと、すでにメッセージ表示の仕組みが実装されているはずです。

**`app/assets/svelte/layouts/LayoutSideMenu.svelte` (抜粋)**
```svelte
<script lang="ts">
  import { message } from '~/stores/message';
  import { Alert } from 'sveltestrap';

  // ...
</script>

<main>
  {#if $message}
    <div class="container-fluid mt-3">
      <Alert color={$message.color} isOpen={true} toggle={() => ($message = null)}>
        {$message.text}
      </Alert>
    </div>
  {/if}

  <!-- ... ページコンテナなど ... -->
</main>
```
- **`import { message } from '~/stores/message';`**:
  メッセージストアをインポートします。
- **`$message`**:
  Svelteのストアを購読するための便利な糖衣構文です。ストア名の前に `$` を付けるだけで、そのストアの現在の値をリアクティブに受け取ることができます。`message` ストアの値が `null` からメッセージオブジェクトに変わると、このコンポーネントは自動的に再描画されます。
- **`{#if $message}`**:
  `$message` が `null` でない場合（つまり、表示すべきメッセージがある場合）のみ、`Alert` コンポーネントを描画します。
- **`<Alert color={$message.color} ...>`**:
  Sveltestrapの `Alert` コンポーネントを使って、メッセージを見栄え良く表示します。`color` やテキストの内容は、ストアから受け取ったオブジェクトのプロパティをそのまま使っています。
- **`toggle={() => ($message = null)}`**:
  `Alert` コンポーネントの閉じるボタンがクリックされたときに、ストアの値を `null` に戻す処理を定義しています。これにより、ユーザーが手動でメッセージを消すこともできます。

### 動作確認

1.  新規登録または編集フォームでタスクを保存します。
2.  一覧画面にリダイレクトされた後、画面の上部に「タスクを登録しました。」や「タスクを更新しました。」という緑色のメッセージが数秒間表示されれば成功です。

---

Svelteストアを使うことで、直接的な親子関係にないコンポーネント間でも、簡単かつクリーンに状態を共有できることが分かりました。これは、アプリケーション全体の通知、ユーザーのログイン状態、選択中のテーマなど、グローバルな状態管理に非常に有効なパターンです。
