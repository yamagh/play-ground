# 4-6. 応用: 検索とページネーション機能の実装

タスク一覧が表示できるようになったので、次はより実用的な機能として「検索」と「ページネーション」を実装してみましょう。タスクが増えてきても、目的のタスクを素早く見つけたり、一覧を快適に閲覧したりできるようになります。

この実装は、バックエンドとフロントエンド双方の機能拡張が必要です。

## バックエンドの機能拡張

まずはバックエンドから。Controllerが検索キーワードやページ番号をクエリパラメータとして受け取れるようにし、Repositoryがそれらの条件に基づいてデータを取得できるようにします。

### 1. Repositoryの拡張

`app/repository/TaskRepository.java` に、検索条件とページネーションのパラメータを受け取る新しいメソッドを追加します。

```java
package repository;

import io.ebean.Ebean;
import io.ebean.EbeanServer;
import io.ebean.PagedList;
import models.Task;
import play.db.ebean.EbeanConfig;

import javax.inject.Inject;
import java.util.List;
import java.util.concurrent.CompletionStage;

import static java.util.concurrent.CompletableFuture.supplyAsync;

public class TaskRepository {

    private final EbeanServer ebeanServer;
    private final DatabaseExecutionContext executionContext;
    private static final int PAGE_SIZE = 10; // 1ページあたりの件数

    @Inject
    public TaskRepository(EbeanConfig ebeanConfig, DatabaseExecutionContext executionContext) {
        this.ebeanServer = Ebean.getServer(ebeanConfig.defaultServer());
        this.executionContext = executionContext;
    }

    /**
     * 条件を指定してタスクのページリストを取得します。
     * @param page ページ番号 (0-indexed)
     * @param query 検索クエリ（titleに対する部分一致）
     */
    public CompletionStage<PagedList<Task>> page(int page, String query) {
        return supplyAsync(() -> {
            var q = ebeanServer.find(Task.class)
                .orderBy("id");

            if (query != null && !query.isEmpty()) {
                q.where().icontains("title", query);
            }

            return q.setFirstRow(PAGE_SIZE * page)
                .setMaxRows(PAGE_SIZE)
                .findPagedList();
        }, executionContext);
    }
    
    // all() メソッドは削除するか、内部で page(0, "") を呼ぶように修正しても良い
}
```
- **`page(int page, String query)`**: 新しく追加したメソッドです。ページ番号と検索クエリを引数に取ります。
- **`icontains("title", query)`**: `title` カラムに対して、大文字・小文字を区別しない部分一致検索（`ILIKE '%query%'`）を行う条件を追加します。
- **`findPagedList()`**: Ebeanのメソッドで、結果リストだけでなく、総件数などのページネーション情報を含む `PagedList` オブジェクトを返します。

### 2. Controllerの拡張

次に `app/controllers/api/TaskController.java` を修正し、HTTPリクエストのクエリパラメータを受け取ってRepositoryに渡すようにします。

```java
package controllers.api;

// ... (importは省略)
import play.mvc.Http;

public class TaskController extends Controller {

    private final TaskRepository taskRepository;

    @Inject
    public TaskController(TaskRepository taskRepository) {
        this.taskRepository = taskRepository;
    }

    public CompletionStage<Result> list(Http.Request request) {
        // クエリパラメータから値を取得。なければデフォルト値を使用。
        int page = request.getQueryString("page").map(Integer::parseInt).orElse(0);
        String query = request.getQueryString("query").orElse("");

        return taskRepository.page(page, query).thenApplyAsync(pagedList -> {
            // PagedListをそのままJSONにすると不要な情報も含まれるため、
            // フロントエンドが必要な情報だけを詰めたカスタムオブジェクトを返すのが一般的。
            // ここでは簡単のため、リストと総件数を返すようにする。
            var result = new java.util.HashMap<String, Object>();
            result.put("data", pagedList.getList());
            result.put("totalCount", pagedList.getTotalCount());
            return ok(Json.toJson(result));
        });
    }
}
```
- **`list(Http.Request request)`**: アクションメソッドに `Http.Request` 型の引数を追加すると、Playが現在のリクエストオブジェクトを渡してくれます。
- **`request.getQueryString(...)`**: `?page=1&query=Svelte` のようなクエリ文字列から、指定したキーの値を取得します。`orElse` を使って、パラメータが存在しない場合のデフォルト値を設定しています。
- **レスポンス形式の変更**: フロントエンドでページネーションUIを実装できるように、タスクのリスト (`data`) だけでなく、総件数 (`totalCount`) もレスポンスに含めるように変更しました。

### 3. routesの修正

Controllerの `list` メソッドが引数を取るようになったため、`conf/routes` の記述も修正が必要です。

```
# 変更前
# GET     /api/tasks                  controllers.api.TaskController.list

# 変更後
GET     /api/tasks                  controllers.api.TaskController.list(request: Request)
```
`list` メソッドにリクエストオブジェクトが渡されるように `(request: Request)` を追記します。

## フロントエンドの機能拡張

バックエンドの準備ができたので、フロントエンドを実装します。検索ボックスとページネーションUIを追加し、ユーザーの操作に応じてパラメータ付きでAPIを再呼び出しするようにします。

*このセクションは非常に長くなるため、このチュートリアルでは概念的な実装方針の解説に留めます。完全なコードは完成版のソースコードを参照してください。*

### 1. UIコンポーネントの作成
- **検索ボックス**: `Sveltestrap` の `Input` コンポーネントを使って、検索キーワードを入力するためのUIを作成します。
- **ページネーションUI**: 現在のページ、総ページ数、前/次ページへ移動するボタンなどを持つコンポーネントを作成します。`Sveltestrap` の `Pagination` コンポーネントが利用できます。

### 2. 状態管理
Svelteコンポーネント内に、現在の検索キーワードとページ番号を保持するためのリアクティブな状態（`$state`）を追加します。

```typescript
let query = $state('');
let currentPage = $state(0);
let totalCount = $state(0);
const pageSize = 10;

let totalPages = $derived(Math.ceil(totalCount / pageSize));
```
`$derived` を使って、総件数とページサイズから総ページ数を計算しています。

### 3. APIの再呼び出し
検索キーワードが変更されたり、ページネーションボタンがクリックされたりした際に、APIを再度呼び出す関数を実装します。

Svelte 5の `$effect` Runeを使うと、特定の状態が変更されたときに副作用（この場合はAPI呼び出し）を実行する処理を簡潔に記述できます。

```typescript
$effect(() => {
  // query または currentPage が変更されるたびにこの中が実行される
  fetchData(currentPage, query);
});

async function fetchData(page: number, q: string) {
  isLoading = true;
  try {
    // URLSearchParamsを使ってクエリパラメータを構築
    const params = new URLSearchParams();
    params.set('page', page.toString());
    params.set('query', q);
    
    const res = await api.get<{ data: Task[]; totalCount: number; }>(`tasks?${params.toString()}`);
    tasks = res.data.data;
    totalCount = res.data.totalCount;
  } catch (e) {
    console.error(e);
  } finally {
    isLoading = false;
  }
}
```
`URLSearchParams` を使うと、オブジェクトから `page=0&query=test` のようなクエリ文字列を安全に生成できます。

---

これらの変更により、タスク一覧画面は単にデータを表示するだけでなく、ユーザーが能動的にデータを絞り込んだり、大量のデータを効率的に閲覧したりできる、よりインタラクティブで実用的な機能を持つようになります。
