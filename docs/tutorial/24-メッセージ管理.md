# 5-5. メッセージ管理

フィードバックメッセージの実装で、「タスクを登録しました。」といった文言をソースコード内に直接記述しました（ハードコーディング）。小規模なアプリケーションではこれでも問題ありませんが、規模が大きくなったり、多言語対応が必要になったりすると、メッセージの管理が煩雑になります。

この章では、Play Frameworkとフロントエンドが連携した、より高度なメッセージ管理の方法について学びます。

## Play Frameworkのメッセージ管理機能

Play Frameworkには、国際化（i18n）をサポートするためのメッセージ管理機能が組み込まれています。

プロジェクトの `conf/` ディレクトリに、`messages.ja` のような `messages.言語コード` という形式のファイルを作成することで、メッセージをキーと文言のペアで管理できます。

**`conf/messages.ja`**
```properties
# --- General ---
button.save=保存
button.cancel=キャンセル

# --- Task ---
task.created=タスクを登録しました。
task.updated=タスクを更新しました。
```

このようにメッセージを外部ファイルに分離することで、以下のようなメリットがあります。
- **一元管理**: アプリケーションで使う文言が一箇所にまとまるため、表記の揺れを防ぎ、修正も容易になります。
- **多言語対応**: `messages.en`, `messages.fr` のように言語ごとのファイルを用意するだけで、ユーザーの言語設定に応じてPlayが自動的に適切なメッセージを選択してくれます。
- **コードの分離**: ロジックと表示用テキストを分離でき、コードの見通しが良くなります。

### Controllerでのメッセージ取得

Controller内でメッセージを取得するには、`MessagesApi` を使います。

```java
import play.i18n.Messages;
import play.i18n.MessagesApi;

// ...

public class MyController extends Controller {
    private final MessagesApi messagesApi;

    @Inject
    public MyController(MessagesApi messagesApi) {
        this.messagesApi = messagesApi;
    }

    public Result myAction(Http.Request request) {
        // リクエストに応じた言語のメッセージを取得
        Messages messages = messagesApi.preferred(request);
        String saveButtonLabel = messages.at("button.save"); // "保存"
        // ...
    }
}
```

## フロントエンドでのメッセージ管理

バックエンドのメッセージをフロントエンドでも活用したい、というケースは頻繁にあります。このプロジェクトでは、その連携をスムーズに行うための仕組みが用意されています。

### メッセージファイルの自動生成

`package.json` を見ると、`messages` というnpmスクリプトが定義されています。

**`package.json`**
```json
{
  "scripts": {
    "messages": "node scripts/generate-messages.js"
  }
}
```
このコマンドを実行すると、`scripts/generate-messages.js` というスクリプトが `conf/messages.ja` ファイルを読み込み、その内容をTypeScriptのオブジェクトに変換して `app/assets/svelte/generated/messages.ts` というファイルを自動生成します。

```bash
npm run messages
```

**`app/assets/svelte/generated/messages.ts` (自動生成されたファイル)**
```typescript
// @ts-nocheck
// prettier-ignore
//
// DO NOT EDIT THIS FILE.
// IT'S GENERATED BY "npm run messages"
//
export default {
  "button": {
    "save": "保存",
    "cancel": "キャンセル"
  },
  "task": {
    "created": "タスクを登録しました。",
    "updated": "タスクを更新しました。"
  }
};
```

### フロントエンドでの利用

この自動生成されたファイルと、国際化を補助する `i18n.ts` を使うことで、フロントエンドでもバックエンドと共通のメッセージを安全に利用できます。

**`app/assets/svelte/stores/i18n.ts` (抜粋)**
```typescript
import messages from '~/generated/messages';

// メッセージキーを受け取り、対応する文言を返す関数
export function t(key: string, ...args: any[]): string {
  // ... (キーの存在チェックやプレースホルダー置換のロジック)
  return message;
}
```

**Svelteコンポーネントでの利用例**
```svelte
<script lang="ts">
  import { t } from '~/stores/i18n';
</script>

<!-- "保存" と表示される -->
<Button>{t('button.save')}</Button>
```
`t('task.created')` のようにキーを渡すことで、対応するメッセージを取得できます。キーを間違えると型エラーが出るため、安全にメッセージを参照できます。

### フロントエンド固有のメッセージ

もちろん、フロントエンドだけで使用するメッセージもあります。その場合は、`i18n.ts` の中に直接定義したり、別のメッセージファイルを作成してインポートしたりといった方法で管理できます。

---

このように、メッセージを外部ファイルで一元管理し、ビルドプロセスを通じてフロントエンドと共有する仕組みを整えることで、メンテナンス性が高く、将来的な多言語対応も容易なアプリケーションを構築することができます。
