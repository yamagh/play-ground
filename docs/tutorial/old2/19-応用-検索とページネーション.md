# 19. 応用: 検索とページネーション

一覧画面には、特定の条件でのデータ絞り込み（検索）や、大量のデータを複数ページに分割して表示する（ページネーション）といった機能がしばしば求められます。
ここでは、`tasks` 画面を例に、これらの応用的な機能の実装方法をバックエンドとフロントエンドの両面から解説します。

## 1. バックエンド (API) の拡張

まず、APIが検索キーワードやページ番号といったパラメータを受け取れるように、`TaskRepository` と `TaskController` を拡張します。

### TaskRepository の動的クエリ構築

`TaskRepository` の `find` メソッドを、リクエストパラメータに応じて `WHERE` 句や `LIMIT`/`OFFSET` 句を動的に組み立てるように修正します。

**`app/repository/TaskRepository.java`**:
```java
// ...
import io.ebean.PagedList;
// ...

public class TaskRepository {
    private static final int PAGE_SIZE = 10; // 1ページあたりの表示件数

    public PagedList<Task> find(final String term, final int page) {
        final ExpressionList<Task> expressionList = DB.find(Task.class).where();

        // 検索キーワードが指定されていれば、WHERE句を追加
        if (term != null && !term.isEmpty()) {
            expressionList.icontains("subject", term);
        }

        // ページネーションの設定とクエリ実行
        return expressionList
            .setFirstRow(PAGE_SIZE * (page - 1)) // 開始行 (OFFSET)
            .setMaxRows(PAGE_SIZE)               // 最大取得件数 (LIMIT)
            .orderBy("id asc")
            .findPagedList(); // findList() の代わりに findPagedList() を使う
    }
}
```
- `setFirstRow(offset)`: 何件目のレコードから取得を開始するかを指定します。
- `setMaxRows(limit)`: 最大で何件のレコードを取得するかを指定します。
- `findPagedList()`: このメソッドは、単にデータのリストを返すだけでなく、総件数 (`total`) や現在のページ番号などを含む `PagedList` オブジェクトを返します。これにより、APIのレスポンスにページネーション情報を含めることが容易になります。

### TaskController でのパラメータ受け取り

`TaskController` で、クエリパラメータから `term` と `page` を受け取り、`TaskRepository` に渡します。

**`app/controllers/api/TaskController.java`**:
```java
// ...
public class TaskController extends Controller {
    // ...
    public Result list(Http.Request request) {
        // クエリパラメータから検索キーワードとページ番号を取得
        final String term = request.getQueryString("term");
        final int page = request.getQueryString("page").map(Integer::parseInt).orElse(1);

        final PagedList<Task> tasks = this.taskRepository.find(term, page);
        return ok(Json.toJson(tasks));
    }
}
```
- `request.getQueryString("page").map(Integer::parseInt).orElse(1)`:
  `page` パラメータを取得し、`Integer` に変換します。もしパラメータが存在しない場合は、デフォルト値として `1` を使用します。

## 2. フロントエンド (Svelte) の実装

次に、Svelte側で検索フォームとページネーションのUIを実装し、パラメータを付けてAPIを呼び出すようにします。

### 状態管理とAPI再呼び出し

検索キーワードや現在のページ番号といった「画面の状態」をSvelteの `$state` で管理します。そして、検索ボタンが押されたり、ページネーションのリンクがクリックされたりした際に、これらの状態変数を更新し、新しいパラメータでAPIを再呼び出しする関数を実装します。

**`app/assets/svelte/screens/tasks/Page.svelte`**:
```svelte
<script lang="ts">
  import { onMount } from "svelte";
  import { fetchTasks, type TasksApiResponse } from "./api";
  import Pagination from "@app/assets/svelte/components/common/Pagination.svelte";

  // 画面の状態を管理する変数
  let tasksResponse: TasksApiResponse | null = null;
  let term = $state(""); // 検索キーワード
  let page = $state(1);   // 現在のページ番号

  // データを取得する関数
  const loadTasks = async () => {
    tasksResponse = await fetchTasks(term, page);
  };

  // 検索実行時の処理
  const handleSearch = () => {
    page = 1; // 検索時は1ページ目に戻す
    loadTasks();
  };

  // ページ変更時の処理 (Paginationコンポーネントから呼び出される)
  const handlePageChange = (e: CustomEvent<{ page: number }>) => {
    page = e.detail.page;
    loadTasks();
  };

  // 初期表示
  onMount(loadTasks);
</script>

<!-- 検索フォーム -->
<input type="text" bind:value={term} />
<button on:click={handleSearch}>Search</button>

<!-- ... テーブル表示 ... -->

<!-- ページネーションコンポーネント -->
{#if tasksResponse}
  <Pagination
    currentPage={page}
    totalItems={tasksResponse.total}
    pageSize={10}
    on:pageChange={handlePageChange}
  />
{/if}
```

### コードの解説
- `let term = $state("")`, `let page = $state(1)`:
  Svelte 5 の [Runes](https://svelte.dev/blog/runes) という機能を使って、リアクティブな状態変数を宣言しています。これらの変数の値が変更されると、UIが自動的に更新されます。
- `loadTasks()`:
  APIを呼び出すロジックを独立した関数に切り出しています。これにより、初期表示、検索実行、ページ変更といった複数の場面から同じロジックを再利用できます。
- `handleSearch()`:
  検索ボタンがクリックされたときに呼ばれます。ページ番号を `1` にリセットしてから `loadTasks()` を呼び出します。
- `bind:value={term}`:
  `input` 要素の入力値と `term` 変数を双方向にバインディングします。ユーザーがテキストを入力すると、`term` の値が自動的に更新されます。
- `<Pagination ... />`:
  共通コンポーネントである `Pagination.svelte` を使用しています。
  - `props` (`currentPage`, `totalItems`, `pageSize`) を渡すことで、ページネーションの表示を制御します。
  - `on:pageChange={handlePageChange}`: `Pagination` コンポーネント内でページリンクがクリックされると、`pageChange` というカスタムイベントが発生します。このイベントを捕捉し、`handlePageChange` 関数を実行することで、ページ番号の変更を検知しています。
