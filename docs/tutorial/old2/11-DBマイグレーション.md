# 11. DBマイグレーション (Evolutions)

動的なWebアプリケーションを開発する上で、データベースのテーブル構造（スキーマ）の管理は非常に重要です。
開発が進むにつれて、「テーブルに新しいカラムを追加したい」「新しいテーブルを作成したい」といった要求が頻繁に発生します。

Play Frameworkには、**Evolutions** というデータベースマイグレーションのための仕組みが組み込まれています。
Evolutionsは、SQLスクリプトを使ってデータベーススキーマの変更をバージョン管理するための機能です。

## Evolutionsスクリプトの作成

Evolutionsスクリプトは、`conf/evolutions/default/` ディレクトリに配置します。
ファイル名は `1.sql`, `2.sql`, `3.sql` ... のように、連番にする必要があります。Playは、この番号順にスクリプトを実行していきます。

このプロジェクトには、既に `1.sql` (usersテーブル作成) と `2.sql` (tasksテーブル作成) が存在します。
ここでは例として、tasksテーブルに `memo` というカラムを追加するための `3.sql` を作成してみましょう。

`conf/evolutions/default/` に `3.sql` という新しいファイルを作成し、以下の内容を記述してください。

**`conf/evolutions/default/3.sql`**:
```sql
# --- !Ups

ALTER TABLE tasks ADD COLUMN memo VARCHAR(255);

# --- !Downs

ALTER TABLE tasks DROP COLUMN memo;
```

## Ups と Downs

Evolutionsスクリプトは、`# --- !Ups` と `# --- !Downs` という2つのセクションで構成されます。

- **`# --- !Ups`**:
  このセクションには、データベーススキーマに**変更を加える**ためのSQLを記述します。この例では、`tasks` テーブルに `memo` カラムを追加しています。Playは、マイグレーションを適用する際にこの部分を実行します。

- **`# --- !Downs`**:
  このセクションには、`Ups` セクションで行った変更を**元に戻す**ためのSQLを記述します。この例では、追加した `memo` カラムを削除しています。これにより、問題が発生した場合に、データベースを以前の状態に安全に戻すことができます。

`Downs` を記述することは、データベースの変更履歴を可逆的に保つために非常に重要です。

## マイグレーションの適用

開発モード (`sbt run`) でアプリケーションを実行している場合、Playはデータベースの状態とEvolutionsスクリプトの間に矛盾を検知すると、自動的にブラウザ上で通知してくれます。

1.  `3.sql` を作成して保存します。
2.  ブラウザでアプリケーション (`http://localhost:9000`) にアクセスすると、"Database 'default' needs evolution!" というメッセージが表示されます。
3.  これは、Playが「データベースの現在の状態（`2.sql` まで適用済み）と、コード（`3.sql` が存在する）が一致しない」ことを検知したことを意味します。
4.  **"Apply this script now!"** という青いボタンをクリックします。
5.  Playは `3.sql` の `Ups` セクションを実行し、データベースのスキーマを更新します。

これで、`tasks` テーブルに `memo` カラムが追加されました。
このように、Evolutionsを使うことで、チームメンバー全員がデータベーススキーマの変更を安全かつ確実に追跡・適用することができます。
