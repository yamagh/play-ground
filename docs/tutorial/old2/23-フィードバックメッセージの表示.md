# 23. フィードバックメッセージの表示

「タスクを保存しました」のような、操作の結果をユーザーに伝えるフィードバックメッセージは、優れたユーザー体験のために不可欠です。
しかし、このメッセージ表示機能を各ページで個別に実装するのは非効率です。

このプロジェクトでは、Svelteの **ストア (Store)** という機能を使って、アプリケーションのどこからでも呼び出せる、共通のメッセージ表示の仕組みを実装しています。

## Svelteのストアとは？

ストアは、コンポーネントツリーの外で値を保持・管理するためのオブジェクトです。
どのコンポーネントからでも、ストアの値を購読（subscribe）したり、値を更新したりできます。これにより、コンポーネント間で親子関係がない場合でも、簡単に状態を共有できます。

## メッセージストアの仕組み

このプロジェクトのメッセージ機能は、以下の3つのファイルで構成されています。

1.  **`@app/assets/svelte/stores/message.ts` (ストア本体)**
    ここで、メッセージの状態（表示/非表示、内容、色など）を管理するストアを定義しています。

    **`stores/message.ts`**:
    ```typescript
    import { writable } from "svelte/store";

    // ... (Messageインターフェースの定義) ...

    // writableストアを作成
    export const message = writable<Message | null>(null);

    // メッセージを表示するためのヘルパー関数
    export const showSuccess = (text: string) => {
      message.set({ type: "success", text });
    };

    export const showError = (text: string) => {
      message.set({ type: "error", text });
    };
    ```
    - `writable`: Svelteに組み込まれているストアの一種で、外部から `set` (値のセット) や `update` (値の更新) が可能なストアを作成します。
    - `message.set(...)`: この関数を呼び出すことで、ストアに新しいメッセージオブジェクトがセットされ、このストアを購読しているすべてのコンポーネントに通知が送られます。

2.  **`@app/assets/svelte/components/layouts/MessageContainer.svelte` (メッセージ表示コンポーネント)**
    このコンポーネントは、`message` ストアを購読し、その内容に応じてメッセージを画面に表示する役割だけを担います。

    **`MessageContainer.svelte`**:
    ```svelte
    <script lang="ts">
      import { message } from "@app/assets/svelte/stores/message";

      // ストアの値が変更されると、このコンポーネントが自動的に再描画される
      const currentMessage = $message;

      // ... (数秒後にメッセージを自動的に消すロジック) ...
    </script>

    {#if currentMessage}
      <div class="alert alert-{currentMessage.type}">
        {currentMessage.text}
      </div>
    {/if}
    ```
    - `$message`: Svelteの構文で、ストアの値を自動的に購読するためのショートハンドです。`message` ストアの値が更新されると、`$message` の値も自動的に更新され、このコンポーネントが再描画されます。
    - このコンポーネントは、共通レイアウト (`LayoutSideMenu.svelte`) の中に配置されているため、どのページを表示していてもメッセージを表示できます。

3.  **呼び出し側コンポーネント (例: `task-edit/Page.svelte`)**
    APIの呼び出しが成功した後など、メッセージを表示したいタイミングで、ストアのヘルパー関数を呼び出します。

    **`task-edit/Page.svelte`**:
    ```svelte
    <script lang="ts">
      import { showSuccess } from "@app/assets/svelte/stores/message";
      // ...

      const handleSubmit = async () => {
        // ... (API呼び出し) ...
        
        // 成功メッセージを表示
        showSuccess("Task saved successfully.");
        
        goto("/tasks");
      };
    </script>
    ```

## 処理の流れのまとめ

1.  `task-edit` 画面でフォームを送信し、API呼び出しが成功します。
2.  `handleSubmit` 関数内で `showSuccess("...")` が呼び出されます。
3.  `stores/message.ts` の `message.set(...)` が実行され、メッセージストアの状態が更新されます。
4.  `MessageContainer.svelte` は、`$message` を通じてストアの更新を検知します。
5.  `MessageContainer.svelte` が再描画され、`{#if $message}` ブロックが `true` になり、画面上部にメッセージが表示されます。

このようにストアを使うことで、メッセージを表示したいコンポーネントは「メッセージを表示する」という関心を `stores/message.ts` に委譲でき、自身はメッセージが実際にどのように表示されるかを気にする必要がなくなります。
