# 3-1. データベースの準備 (DBマイグレーション)

これまでは静的なWebページを作成してきましたが、ここからはタスクを保存するためのデータベースを準備し、動的なアプリケーションへと進化させていきます。

データベースのテーブル構造（スキーマ）は、アプリケーションの機能追加や変更に伴って変化していくものです。このスキーマの変更を安全かつ確実に管理するための仕組みが「データベースマイグレーション」です。

## Evolutionsとは

Play Frameworkには、「**Evolutions**」というDBマイグレーション機能が標準で組み込まれています。

Evolutionsは、データベーススキーマへの変更を、連番のSQLスクリプトファイルとしてバージョン管理します。これにより、誰がどの環境で作業しても、データベースを常に期待される状態に保つことができます。

主な目的は以下の通りです。
- **スキーマ変更のバージョン管理**: `1.sql`, `2.sql`, `3.sql`... のように、変更履歴をSQLファイルとしてコードと共にGitなどで管理できます。
- **環境間の一貫性**: 開発、テスト、本番といった異なる環境でも、同じマイグレーションスクリプトを適用することで、スキーマのズレを防ぎます。
- **安全な適用とロールバック**: 新しいバージョンのスクリプトを適用したり、問題があった際に前のバージョンに戻したりする操作を安全に行えます。

## Evolutionsスクリプトの作成

それでは、タスクを管理するための `task` テーブルを作成するマイグレーションスクリプトを作成しましょう。

`conf/evolutions/default/` ディレクトリに `1.sql` というファイルが既に存在するかと思います。もし存在する場合はそのファイルを開き、なければ新しく作成して、以下の内容を記述してください。（既存の内容は上書きして構いません）

**`conf/evolutions/default/1.sql`**
```sql
# --- !Ups

CREATE TABLE task (
  id                            bigint auto_increment not null,
  title                         varchar(255) not null,
  is_done                       boolean default false not null,
  created_at                    timestamp not null,
  updated_at                    timestamp not null,
  constraint pk_task primary key (id)
);

# --- !Downs

DROP TABLE IF EXISTS task;
```

### スクリプトの解説

EvolutionsのSQLスクリプトは、`# --- !Ups` と `# --- !Downs` という2つのセクションで構成されます。

- **`# --- !Ups`**:
  このマイグレーションを「適用」する際のSQLを記述します。通常は `CREATE TABLE` や `ALTER TABLE` など、スキーマを進化させるためのステートメントです。
  ここでは、`task` テーブルを作成しています。
  - `id`: 主キー
  - `title`: タスクのタイトル
  - `is_done`: 完了したかどうかを示すフラグ
  - `created_at`, `updated_at`: レコードの作成・更新日時

- **`# --- !Downs`**:
  このマイグレーションを「取り消す（ロールバックする）」際のSQLを記述します。`!Ups` セクションで行った変更を元に戻す処理を書きます。
  ここでは、`task` テーブルが存在すれば削除する `DROP TABLE` ステートメントを記述しています。

## マイグレーションの適用

`sbt run` で開発サーバーが起動している状態で、ブラウザで `http://localhost:9000/tasks` など、いずれかのページにアクセスしてください。

Play Frameworkは、データベースの状態と `conf/evolutions/default/` ディレクトリにあるスクリプトを比較し、まだ適用されていないスクリプト（この場合は `1.sql`）があることを検知します。

すると、ブラウザの画面に「**Database 'default' needs evolution!**」というメッセージが表示されます。これは「データベースに変更を適用する必要がありますよ」という通知です。

![Play Evolutions Screen](https://www.playframework.com/documentation/3.0.x/images/evolutions.png)
*(画像はPlay Framework公式ドキュメントより)*

青い **[Apply this script now!]** ボタンをクリックしてください。

Play Frameworkが `1.sql` の `!Ups` セクションに書かれたSQLを実行し、データベースに `task` テーブルが作成されます。処理が完了すると、画面は自動的にリフレッシュされ、元のタスク一覧ページが表示されます。

これで、データを保存するための器が用意できました。

---

次の章では、なぜこのようなDBマイグレーションという仕組みが重要なのか、その背景にある考え方をもう少し詳しく解説します。
